// Copyright 2020-2021 Beken
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

#include <driver/int.h>
#include <os/mem.h>
#include <driver/gpio.h>
#include <driver/gpio_types.h>
#include <driver/jpeg_enc.h>
#include <driver/jpeg_enc_types.h>
#include <driver/dvp_camera.h>
#include <driver/dvp_camera_types.h>

#include <driver/i2c.h>

#include "dvp_sensor_devices.h"

#define GC0312_WRITE_ADDRESS (0x42)
#define GC0312_READ_ADDRESS (0x43)
#define GC0312_CHIP_ID (0xB3)
#define FLIP_INIT_GC0312 0x10

#define TAG "gc0312"
#define LOGI(...) BK_LOGI(TAG, ##__VA_ARGS__)
#define LOGW(...) BK_LOGW(TAG, ##__VA_ARGS__)

#define SENSOR_I2C_READ(reg, value) \
	do {\
		dvp_camera_i2c_read_uint8((GC0312_WRITE_ADDRESS >> 1), reg, value);\
	}while (0)

#define SENSOR_I2C_WRITE(reg, value) \
	do {\
		dvp_camera_i2c_write_uint8((GC0312_WRITE_ADDRESS >> 1), reg, value);\
	}while (0)


bool gc0312_read_flag = false;

// gc0312_DEV
#if 1
const uint8_t sensor_gc0312_init_talbe[][2] =
{

		{0xfe, 0xf0},
		{0xfe, 0xf0},
		{0xfe, 0x00},
		{0xfc, 0x0e},
		{0xfc, 0x0e},
		{0xf2, 0x07},
		{0xf3, 0x00}, // output_disable
		{0xf7, 0x1b},
		{0xf8, 0x04},
		{0xf9, 0x0e},
		{0xfa, 0x11},

		/////////////////////////////////////////////////
		/////////////////  CISCTL reg	/////////////////
		/////////////////////////////////////////////////
		{0x00, 0x2f},
		{0x01, 0x0f}, // 06
		{0x02, 0x04},
		{0x03, 0x03},
		{0x04, 0x50},
		{0x09, 0x00},
		{0x0a, 0x00},
		{0x0b, 0x00},
		{0x0c, 0x04},
		{0x0d, 0x01},
		{0x0e, 0xe8},
		{0x0f, 0x02},
		{0x10, 0x88},
		{0x16, 0x00},
		{0x17, FLIP_INIT_GC0312}, ////0x14
		{0x18, 0x1a},
		{0x19, 0x14},
		{0x1b, 0x48},
		{0x1c, 0x1c},
		{0x1e, 0x6b},
		{0x1f, 0x28},
		{0x20, 0x8b}, // 89 travis 20140801
		{0x21, 0x49},
		{0x22, 0xb0},
		{0x23, 0x04},
		{0x24, 0x16},
		{0x34, 0x20},

		/////////////////////////////////////////////////
		////////////////////   BLK	 ////////////////////
		/////////////////////////////////////////////////
		{0x26, 0x23},
		{0x28, 0xff},
		{0x29, 0x00},
		{0x32, 0x00},
		{0x33, 0x10},
		{0x37, 0x20},
		{0x38, 0x10},
		{0x47, 0x80},
		{0x4e, 0x66},
		{0xa8, 0x02},
		{0xa9, 0x80},

		/////////////////////////////////////////////////
		//////////////////	ISP reg   ///////////////////
		/////////////////////////////////////////////////
		{0x40, 0xff},
		{0x41, 0x21},
		{0x42, 0xcf},
		{0x44, 0x00},
		{0x45, 0xa8},
		{0x46, 0x03}, // sync
		{0x4a, 0x11},
		{0x4b, 0x01},
		{0x4c, 0x20},
		{0x4d, 0x05},
		{0x4f, 0x01},
		{0x50, 0x01}, ////0x01
		{0x55, 0x01},
		{0x56, 0xe0},
		{0x57, 0x02},
		{0x58, 0x80},

		/////////////////////////////////////////////////
		///////////////////   GAIN   ////////////////////
		/////////////////////////////////////////////////
		{0x70, 0x70},
		{0x5a, 0x84},
		{0x5b, 0xc9},
		{0x5c, 0xed},
		{0x77, 0x74},
		{0x78, 0x40},
		{0x79, 0x5f},

		/////////////////////////////////////////////////
		///////////////////   DNDD  /////////////////////
		/////////////////////////////////////////////////
		{0x82, 0x14},
		{0x83, 0x0b},
		{0x89, 0xf0},

		/////////////////////////////////////////////////
		//////////////////   EEINTP  ////////////////////
		/////////////////////////////////////////////////
		{0x8f, 0xaa},
		{0x90, 0x8c},
		{0x91, 0x90},
		{0x92, 0x03},
		{0x93, 0x03},
		{0x94, 0x05},
		{0x95, 0x65},
		{0x96, 0xf0},

		/////////////////////////////////////////////////
		/////////////////////  ASDE  ////////////////////
		/////////////////////////////////////////////////
		{0xfe, 0x00},

		{0x9a, 0x20},
		{0x9b, 0x80},
		{0x9c, 0x40},
		{0x9d, 0x80},

		{0xa1, 0x30},
		{0xa2, 0x32},
		{0xa4, 0x80}, // 30 travis 20140929
		{0xa5, 0x28}, // 30 travis 20140929
		{0xaa, 0x30}, // 10 travis 20140929
		{0xac, 0x22},

		/////////////////////////////////////////////////
		///////////////////   GAMMA   ///////////////////
		/////////////////////////////////////////////////
		/*  {0xfe, 0x00},//default
		  {0xbf, 0x08},
		  {0xc0, 0x16},
		  {0xc1, 0x28},
		  {0xc2, 0x41},
		  {0xc3, 0x5a},
		  {0xc4, 0x6c},
		  {0xc5, 0x7a},
		  {0xc6, 0x96},
		  {0xc7, 0xac},
		  {0xc8, 0xbc},
		  {0xc9, 0xc9},
		  {0xca, 0xd3},
		  {0xcb, 0xdd},
		  {0xcc, 0xe5},
		  {0xcd, 0xf1},
		  {0xce, 0xfa},
		  {0xcf, 0xff},
	  */

		{0xfe, 0x00}, // big gamma
		{0xbf, 0x08},
		{0xc0, 0x1d},
		{0xc1, 0x34},
		{0xc2, 0x4b},
		{0xc3, 0x60},
		{0xc4, 0x73},
		{0xc5, 0x85},
		{0xc6, 0x9f},
		{0xc7, 0xb5},
		{0xc8, 0xc7},
		{0xc9, 0xd5},
		{0xca, 0xe0},
		{0xcb, 0xe7},
		{0xcc, 0xec},
		{0xcd, 0xf4},
		{0xce, 0xfa},
		{0xcf, 0xff},

		/*
			{0xfe, 0x00},//small gamma
			{0xbf, 0x08},
			{0xc0, 0x18},
			{0xc1, 0x2c},
			{0xc2, 0x41},
			{0xc3, 0x59},
			{0xc4, 0x6e},
			{0xc5, 0x81},
			{0xc6, 0x9f},
			{0xc7, 0xb5},
			{0xc8, 0xc7},
			{0xc9, 0xd5},
			{0xca, 0xe0},
			{0xcb, 0xe7},
			{0xcc, 0xec},
			{0xcd, 0xf4},
			{0xce, 0xfa},
			{0xcf, 0xff},
		*/
		/////////////////////////////////////////////////
		///////////////////   YCP  //////////////////////
		/////////////////////////////////////////////////
		{0xd0, 0x40},
		{0xd1, 0x34},
		{0xd2, 0x34},
		{0xd3, 0x40},
		{0xd6, 0xf2},
		{0xd7, 0x1b},
		{0xd8, 0x18},
		{0xdd, 0x03},

		/////////////////////////////////////////////////
		////////////////////   AEC   ////////////////////
		/////////////////////////////////////////////////
		{0xfe, 0x01},
		{0x05, 0x30},
		{0x06, 0x75},
		{0x07, 0x40},
		{0x08, 0xb0},
		{0x0a, 0xc5},
		{0x0b, 0x11}, // 11 01 ae_frame
		{0x0c, 0x00},
		{0x12, 0x52},
		{0x13, 0x40}, // target Y 0x38
		{0x18, 0x95},
		{0x19, 0x96},
		{0x1f, 0x20},
		{0x20, 0xc0}, // 80
		{0x3e, 0x40},
		{0x3f, 0x57},
		{0x40, 0x7d},
		{0x03, 0x60},
		{0x44, 0x02},

		/////////////////////////////////////////////////
		////////////////////   AWB   ////////////////////
		/////////////////////////////////////////////////
		{0xfe, 0x01},
		{0x1c, 0xb1}, // 91
		{0x21, 0x15},
		{0x50, 0x80},
		{0x56, 0x04},
		{0x59, 0x08},
		{0x5b, 0x02},
		{0x61, 0x8d},
		{0x62, 0xa7},
		{0x63, 0xd0},
		{0x65, 0x06},
		{0x66, 0x06},
		{0x67, 0x84},
		{0x69, 0x08},
		{0x6a, 0x25},
		{0x6b, 0x01},
		{0x6c, 0x00},
		{0x6d, 0x02},
		{0x6e, 0xf0},
		{0x6f, 0x80},
		{0x76, 0x80},
		{0x78, 0xaf},
		{0x79, 0x75},
		{0x7a, 0x50},
		{0x7b, 0x50}, // 50
		{0x7c, 0x0c},

		{0x90, 0xc9}, // stable AWB
		{0x91, 0xbe},
		{0x92, 0xe2},
		{0x93, 0xc9},
		{0x95, 0x1b},
		{0x96, 0xe2},
		{0x97, 0x49},
		{0x98, 0x1b},
		{0x9a, 0x49},
		{0x9b, 0x1b},
		{0x9c, 0xc3},
		{0x9d, 0x49},
		{0x9f, 0xc7},
		{0xa0, 0xc8},
		{0xa1, 0x00},
		{0xa2, 0x00},
		{0x86, 0x00},
		{0x87, 0x00},
		{0x88, 0x00},
		{0x89, 0x00},
		{0xa4, 0xb9},
		{0xa5, 0xa0},
		{0xa6, 0xba},
		{0xa7, 0x92},
		{0xa9, 0xba},
		{0xaa, 0x80},
		{0xab, 0x9d},
		{0xac, 0x7f},
		{0xae, 0xbb},
		{0xaf, 0x9d},
		{0xb0, 0xc8},
		{0xb1, 0x97},
		{0xb3, 0xb7},
		{0xb4, 0x7f},
		{0xb5, 0x00},
		{0xb6, 0x00},
		{0x8b, 0x00},
		{0x8c, 0x00},
		{0x8d, 0x00},
		{0x8e, 0x00},
		{0x94, 0x55},
		{0x99, 0xa6},
		{0x9e, 0xaa},
		{0xa3, 0x0a},
		{0x8a, 0x00},
		{0xa8, 0x55},
		{0xad, 0x55},
		{0xb2, 0x55},
		{0xb7, 0x05},
		{0x8f, 0x00},
		{0xb8, 0xcb},
		{0xb9, 0x9b},

		/*
		{0xa4,0xb9}, //default AWB
		{0xa5,0xa0},
		{0x90,0xc9},
		{0x91,0xbe},
		{0xa6,0xb8},
		{0xa7,0x95},
		{0x92,0xe6},
		{0x93,0xca},
		{0xa9,0xbc},
		{0xaa,0x95},
		{0x95,0x23},
		{0x96,0xe7},
		{0xab,0x9d},
		{0xac,0x80},
		{0x97,0x43},
		{0x98,0x24},
		{0xae,0xb7},
		{0xaf,0x9e},
		{0x9a,0x43},
		{0x9b,0x24},
		{0xb0,0xc8},
		{0xb1,0x97},
		{0x9c,0xc4},
		{0x9d,0x44},
		{0xb3,0xb7},
		{0xb4,0x7f},
		{0x9f,0xc7},
		{0xa0,0xc8},
		{0xb5,0x00},
		{0xb6,0x00},
		{0xa1,0x00},
		{0xa2,0x00},
		{0x86,0x60},
		{0x87,0x08},
		{0x88,0x00},
		{0x89,0x00},
		{0x8b,0xde},
		{0x8c,0x80},
		{0x8d,0x00},
		{0x8e,0x00},
		{0x94,0x55},
		{0x99,0xa6},
		{0x9e,0xaa},
		{0xa3,0x0a},
		{0x8a,0x0a},
		{0xa8,0x55},
		{0xad,0x55},
		{0xb2,0x55},
		{0xb7,0x05},
		{0x8f,0x05},
		{0xb8,0xcc},
		{0xb9,0x9a},
		*/
		/////////////////////////////////////////////////
		////////////////////   CC    ////////////////////
		/////////////////////////////////////////////////
		{0xfe, 0x01},

		{0xd0, 0x38}, // skin red
		{0xd1, 0x00},
		{0xd2, 0x02},
		{0xd3, 0x04},
		{0xd4, 0x38},
		{0xd5, 0x12},
		/*
			{0xd0, 0x38},//skin white
			{0xd1, 0xfd},
			{0xd2, 0x06},
			{0xd3, 0xf0},
			{0xd4, 0x40},
			{0xd5, 0x08},
		*/

		/*
			{0xd0, 0x38},//guodengxiang
			{0xd1, 0xf8},
			{0xd2, 0x06},
			{0xd3, 0xfd},
			{0xd4, 0x40},
			{0xd5, 0x00},
		*/
		{0xd6, 0x30},
		{0xd7, 0x00},
		{0xd8, 0x0a},
		{0xd9, 0x16},
		{0xda, 0x39},
		{0xdb, 0xf8},

		/////////////////////////////////////////////////
		////////////////////   LSC   ////////////////////
		/////////////////////////////////////////////////
		{0xfe, 0x01},
		{0xc1, 0x3c},
		{0xc2, 0x50},
		{0xc3, 0x00},
		{0xc4, 0x40},
		{0xc5, 0x30},
		{0xc6, 0x30},
		{0xc7, 0x10},
		{0xc8, 0x00},
		{0xc9, 0x00},
		{0xdc, 0x20},
		{0xdd, 0x10},
		{0xdf, 0x00},
		{0xde, 0x00},

		/////////////////////////////////////////////////
		///////////////////  Histogram	/////////////////
		/////////////////////////////////////////////////
		{0x01, 0x10},
		{0x0b, 0x31},
		{0x0e, 0x50},
		{0x0f, 0x0f},
		{0x10, 0x6e},
		{0x12, 0xa0},
		{0x15, 0x60},
		{0x16, 0x60},
		{0x17, 0xe0},

		/////////////////////////////////////////////////
		//////////////	Measure Window	  ///////////////
		/////////////////////////////////////////////////
		{0xcc, 0x0c},
		{0xcd, 0x10},
		{0xce, 0xa0},
		{0xcf, 0xe6},

		/////////////////////////////////////////////////
		/////////////////	dark sun   //////////////////
		/////////////////////////////////////////////////
		{0x45, 0xf7},
		{0x46, 0xff},
		{0x47, 0x15},
		{0x48, 0x03},
		{0x4f, 0x60},

		//////////////////banding//////////////////////
		{0xfe, 0x00},
		{0x05, 0x02},
		{0x06, 0xd1}, // HB
		{0x07, 0x00},
		{0x08, 0x22}, // VB

		{0xfe, 0x01},
		{0x25, 0x00}, // anti-flicker step [11:8]
		{0x26, 0x6a}, // anti-flicker step [7:0]

		// 212 350 5cc 774
		{0x27, 0x05}, // exp level 0  20fps
		{0x28, 0xcc},
		{0x29, 0x05}, // exp level 1  12.50fps
		{0x2a, 0xcc},
		{0x2b, 0x05}, // 7.14fps
		{0x2c, 0xcc},
		{0x2d, 0x05}, // exp level 3  5.55fps
		{0x2e, 0xcc},
		{0x3c, 0x20},
		{0xfe, 0x00},

		{0xfe, 0x00},
		/////////////banding/////////////

		{0x05, 0x02}, // hb
		{0x06, 0x2c}, //
		{0x07, 0x02}, // vb//0x00
		{0x08, 0xb8}, //
		{0xfe, 0x01}, //
		{0x29, 0x00}, // anti-flicker step [11:8]
		{0x2a, 0x60}, // anti-flicker step [7:0]
		{0x2b, 0x05}, // exp level 0  14.28fps
		{0x2c, 0x40}, //
		{0x2d, 0x05}, // exp level 1  12.50fps
		{0x2e, 0x40}, //
		{0x2f, 0x05}, // exp level 2  10.00fps
		{0x30, 0x40}, //
		{0x31, 0x05}, // exp level 3  7.14fps
		{0x32, 0x40}, //

		// 2a0 300 3c0 540
		//
		{0x2b, 0x02},
		{0x2c, 0xa0}, // 15fps
		{0x2d, 0x03},
		{0x2e, 0x00}, // 11fps
		{0x2f, 0x03},
		{0x30, 0x00}, // 10fps
		{0x31, 0x03},
		{0x32, 0x00}, // 8fps
		{0x33, 0x20},
		/////////////////////////////////////////////////
		/////////////////////  DVP   ////////////////////
		/////////////////////////////////////////////////
		{0xfe, 0x03},
		{0x01, 0x00},
		{0x02, 0x00},
		{0x10, 0x00},
		{0x15, 0x00},
		{0xfe, 0x00},
		///////////////////OUTPUT//////////////////////
		{0xf3, 0xff}, // output_enable

		{0xfe, 0x00},
		{0x44, 0x02}, // YUV

		// 镜头阴影
		// {0xfe, 0x01},//LSC
		// {0xc1, 0x30},//LSC_row_center 3c
		// {0xc2, 0x55},//LSC_col_center 50
		// {0xc3, 0x01},//LSC_sign
		// {0xc7, 0x00},//LSC_R
		// {0xc8, 0xff},//LSC_G
		// {0xc9, 0xff},//LSC_B

};
#endif




const uint8_t sensor_gc0312_QVGA_320_240_talbe[][2] =
	{

};

const uint8_t sensor_gc0312_VGA_640_480_talbe[][2] =
	{


};


bool gc0312_detect(void)
{
	uint8_t data = 0;
    //return false;
	SENSOR_I2C_READ(0xf0, &data);

	LOGW("%s, id: 0x%02X\n", __func__, data);

	if (data == GC0312_CHIP_ID)
	{
		LOGW("%s success\n", __func__);
		return true;
	}

	return false;
}

void gc0312_read_register(uint8_t addr, uint8_t data)

{
	if (gc0312_read_flag)
	{
		if (addr == 0x4e)
		{
			return;
		}

		uint8_t value = 0;
		rtos_delay_milliseconds(2);
		SENSOR_I2C_READ(addr, &value);
		if (value != data)
		{
			LOGI("0x%02x, 0x%02x-0x%02x\r\n", addr, data, value);
		}
	}
}

int gc0312_init(void)

{
	uint32_t size = sizeof(sensor_gc0312_init_talbe) / 2, i;

	LOGI("%s\n", __func__);

	for (i = 0; i < size; i++)
	{
		SENSOR_I2C_WRITE(sensor_gc0312_init_talbe[i][0], sensor_gc0312_init_talbe[i][1]);

		gc0312_read_register(sensor_gc0312_init_talbe[i][0], sensor_gc0312_init_talbe[i][1]);
	}

	return 0;
}

int gc0312_set_ppi(media_ppi_t ppi)
{
	uint32_t size, i;
	int ret = -1;

	LOGI("%s\n", __func__);

	switch (ppi)
	{
	case PPI_320X240:
	{
		size = sizeof(sensor_gc0312_QVGA_320_240_talbe) / 2;

		for (i = 0; i < size; i++)
		{
			SENSOR_I2C_WRITE(sensor_gc0312_QVGA_320_240_talbe[i][0],
							 sensor_gc0312_QVGA_320_240_talbe[i][1]);

			gc0312_read_register(sensor_gc0312_QVGA_320_240_talbe[i][0],
								 sensor_gc0312_QVGA_320_240_talbe[i][1]);
		}

		ret = 0;
	}
	break;

	case PPI_640X480:
	{

		size = sizeof(sensor_gc0312_VGA_640_480_talbe) / 2;
		for (i = 0; i < size; i++)
		{
			SENSOR_I2C_WRITE(sensor_gc0312_VGA_640_480_talbe[i][0],
							 sensor_gc0312_VGA_640_480_talbe[i][1]);

			gc0312_read_register(sensor_gc0312_VGA_640_480_talbe[i][0],
								 sensor_gc0312_VGA_640_480_talbe[i][1]);
		}

		ret = 0;
	}
	break;

	case PPI_800X600:
	case PPI_1280X720:
	default:
		break;
	}

	return ret;
}

int gc0312_set_fps(frame_fps_t fps)
{
	return 0;
}

int gc0312_reset(void)
{
	SENSOR_I2C_WRITE(0xFE, 0x80);
	return 0;
}

int gc0312_dump(media_ppi_t ppi)
{
	uint32_t size, i;
	int ret = -1;
	uint8_t value = 0;

	LOGI("%s\n", __func__);

	size = sizeof(sensor_gc0312_init_talbe) / 2;

	for (i = 0; i < size; i++)
	{
		SENSOR_I2C_READ(sensor_gc0312_init_talbe[i][0], &value);
		LOGI("[0x%02x, 0x%02x]\r\n", sensor_gc0312_init_talbe[i][0], value);
	}

	switch (ppi)
	{
	case PPI_320X240:
	{
		size = sizeof(sensor_gc0312_QVGA_320_240_talbe) / 2;

		for (i = 0; i < size; i++)
		{
			SENSOR_I2C_READ(sensor_gc0312_QVGA_320_240_talbe[i][0], (uint8_t *)&value);
			LOGI("[%02x, %02x]\r\n", sensor_gc0312_QVGA_320_240_talbe[i][0], value);
		}

		ret = 0;
	}
	break;

	case PPI_640X480:
	{
		size = sizeof(sensor_gc0312_VGA_640_480_talbe) / 2;

		for (i = 0; i < size; i++)
		{
			SENSOR_I2C_READ(sensor_gc0312_VGA_640_480_talbe[i][0], &value);
			LOGI("[%02x, %02x]\r\n", sensor_gc0312_VGA_640_480_talbe[i][0], value);
		}

		ret = 0;
	}
	break;

	case PPI_800X600:
	case PPI_1280X720:
	default:
		break;
	}

	ret = kNoErr;

	return ret;

}

void gc0312_read_enable(bool enable)
{
	gc0312_read_flag = enable;
}


const dvp_sensor_config_t dvp_sensor_gc0312 =
{
	.name = "gc0312",
	.clk = MCLK_24M,
	.fmt = PIXEL_FMT_YUYV,
	.vsync = SYNC_HIGH_LEVEL,
	.hsync = SYNC_HIGH_LEVEL,
	/* default config */
	.def_ppi = PPI_640X480,
	.def_fps = FPS25,
	/* capability config */
	.fps_cap = FPS5 | FPS10 | FPS20 | FPS25 | FPS30,
	.ppi_cap = PPI_CAP_320X240 | PPI_CAP_320X480 | PPI_CAP_480X272 | PPI_CAP_640X480 | PPI_CAP_480X320,
	.id = ID_GC0312,
	.address = (GC0312_WRITE_ADDRESS >> 1),
	.init = gc0312_init,
	.detect = gc0312_detect,
	.set_ppi = gc0312_set_ppi,
	.set_fps = gc0312_set_fps,
	.power_down = gc0312_reset,
	.dump_register = gc0312_dump,
	.read_register = gc0312_read_enable,
};

